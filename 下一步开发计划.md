# 下一步开发计划 — PRDCreate + UICreate 功能补全

## 当前状态（已完成）

前端 UI 布局已重构完毕，两个页面可正常渲染：
- 全局 Header 插槽机制（HeaderSlotContext）— 页面控件注入顶栏
- AIInputBar 精简版 — 单行布局，无拖拽/标签冗余
- HTMLPreview — 仅手机+桌面，右上角悬浮切换
- PRDCreate — Markdown textarea + 工具栏 + AI 输入栏 + AI检测/导出弹窗（内联）
- UICreate — iframe 预览 + AI 输入栏 + 导出弹窗（内联）
- MainLayout — create 页面零内边距

**2026-02-26 功能补全（任务 1-9 全部完成）：**
- ✅ 任务 1：types/index.ts — UIDesignVersion/UIDesignItem 新增 htmlContent 字段
- ✅ 任务 2：AppContext — UIDesignInput/createUIDesignVersion 支持 htmlContent，草稿 key 常量
- ✅ 任务 3：PRDCreate 草稿自动保存（1s 节流，新建模式，保存后清除）
- ✅ 任务 4：UICreate 草稿自动保存（同上）
- ✅ 任务 5：PRDCreate AI 写回三策略（选区替换/段落替换/追加末尾）
- ✅ 任务 6：UICreate AI→HTML 多模板联动（登录/注册/仪表盘，颜色关键词调整）
- ✅ 任务 7：弹窗打开时禁用步骤指示器点击（pointer-events-none）
- ✅ 任务 8：UICreate 编辑模式加载 editUIDesign.htmlContent
- ✅ 任务 9：UICreate 保存时写入 htmlContent 到 designPayload
- ✅ 额外：PRDCreate "审查" 改名为 "AI检测"，移除审查阻断逻辑（有 fix 项时警告但不阻断）

---

## 待开发任务（按优先级排序）

### P0 — 数据层补全（必须先做）

#### 任务 1：类型补全 — `src/types/index.ts`
- `UIDesignVersion` 新增 `htmlContent?: string` 字段
- `UIDesignItem` 新增 `htmlContent?: string` 字段
- 不改动 PRDItem/PRDVersion（无需变更）

#### 任务 2：AppContext 更新 — `src/store/AppContext.tsx`
- `UIDesignInput` 类型新增 `htmlContent?: string`
- `buildUIDesignVersion` 函数传递 `htmlContent`
- `createUIDesignVersion` 的 next 参数类型新增 `htmlContent`
- `addUIDesign` 同步更新
- 新增 `STORAGE_KEYS`：
  - `PRD_DRAFT_PREFIX = 'lexin_draft_prd_'`
  - `UI_DRAFT_PREFIX = 'lexin_draft_ui_'`
- 新增草稿存储方法（可选，也可在页面组件内直接操作 localStorage）

### P1 — 草稿自动保存

#### 任务 3：PRDCreate 草稿 — `src/pages/PRDCreate.tsx`
- 新增 `useEffect` + 1 秒节流，将以下字段写入 `localStorage`：
  ```
  key: lexin_draft_prd_{editPRD?.id || 'new'}
  value: { requirementName, requirement, selectedProjectId, priority, selectedModel, updatedAt }
  ```
- 页面加载时检查草稿，有则提示「检测到未保存的草稿，是否恢复？」
- 正式保存（审查通过）后清除草稿 key

#### 任务 4：UICreate 草稿 — `src/pages/UICreate.tsx`
- 同上模式：
  ```
  key: lexin_draft_ui_{editUIDesign?.id || 'new'}
  value: { htmlCode, requirement, selectedPRD, selectedProjectId, updatedAt }
  ```
- 页面加载时检查草稿并提示恢复
- 正式保存后清除草稿 key

### P1 — AI 写回逻辑完善

#### 任务 5：PRDCreate AI 写回三策略 — `src/pages/PRDCreate.tsx`
当前只实现了「选区替换」和「追加末尾」两种，需补全：

| 模式 | 触发条件 | 行为 |
|------|----------|------|
| 选区改写 | `selectionStart !== selectionEnd` | 替换选中区域（已实现） |
| 段落改写 | 光标在段落内，无选区 | 识别当前段落边界，替换整段 |
| 追加末尾 | 编辑器未聚焦 | 追加到文档末尾（已实现） |

需要修改 `handleInsertAIReply` 函数，增加段落改写分支：
```typescript
// 伪代码
if (hasSelection) { replaceSelection(); }
else if (isFocused) { replaceParagraph(); }  // 新增
else { appendToEnd(); }
```

#### 任务 6：UICreate AI→HTML 联动 — `src/pages/UICreate.tsx`
当前 `handleSendMessage` 的 mock 逻辑：
- 首次发送 → 返回固定的 mockLoginHTML
- 后续发送 → 只返回文字回复，不更新 htmlCode

需要改为：
- 首次发送 → mock 返回一个与用户描述相关的 HTML 模板（可准备 2-3 个模板按关键词匹配）
- 后续发送 → mock 返回修改后的 HTML（可做简单的 CSS 变量替换，如颜色、字号）
- 每次都 `setHtmlCode(newHtml)` 让 iframe 实时更新

### P1 — 弹窗状态协调

#### 任务 7：弹窗打开时禁用步骤点击
当前步骤面包屑在 Header 插槽中渲染，弹窗打开时需要禁用点击：
- PRDCreate：`isReviewOpen || isExportOpen` 时，步骤面包屑不可点击
- UICreate：`isExportOpen` 时，步骤面包屑不可点击
- 实现方式：在 setHeaderSlot 的 right 插槽中，根据弹窗状态添加 `pointer-events-none opacity-50`

### P2 — 编辑模式完善

#### 任务 8：从列表页进入编辑模式
- PRDCreate：从 PRDList 点击编辑 → 传入 `editPRD` → 加载内容到编辑器
  - 当前已有基础逻辑，需验证 `htmlContent` 字段是否正确传递
- UICreate：从 UIList 点击编辑 → 传入 `editUIDesign` → 加载 `htmlContent` 到 iframe
  - 当前 mock 用 `mockLoginHTML`，需改为从 `editUIDesign.htmlContent` 加载
  - 如果 `htmlContent` 为空，fallback 到空白状态

#### 任务 9：UICreate 保存时写入 htmlContent
当前 `handleNextStep` 中的 `designPayload` 缺少 `htmlContent`：
```typescript
// 当前
const designPayload = { title, description, prdId, prdTitle, projectId, status, tool };
// 需要改为
const designPayload = { title, description, prdId, prdTitle, projectId, status, tool, htmlContent: htmlCode };
```

### P2 — 导出功能增强

#### 任务 10：PRDCreate 导出弹窗 — 复制到 TAPD
当前导出弹窗有 MD/Word/复制/导入UI 四个选项，「导入到UI设计」已实现跳转。
如果需要 TAPD 集成，需要后续对接 API（当前可保持 mock）。

### P3 — 可选优化

#### 任务 11：审查/导出弹窗提取为独立组件
当前审查弹窗和导出弹窗内联在 PRDCreate.tsx 中（约 100 行），可提取为：
- `src/components/PRDReviewDialog.tsx`
- `src/components/PRDExportDialog.tsx`
- `src/components/UIExportDialog.tsx`

这是纯重构，不影响功能，优先级低。

---

## 文件变更清单

| 文件 | 操作 | 任务编号 |
|------|------|----------|
| `src/types/index.ts` | 修改 | 1 |
| `src/store/AppContext.tsx` | 修改 | 2 |
| `src/pages/PRDCreate.tsx` | 修改 | 3, 5, 7 |
| `src/pages/UICreate.tsx` | 修改 | 4, 6, 7, 8, 9 |

---

## 验证清单

完成后逐项验证：

- [ ] `npx tsc --noEmit` 零错误
- [ ] PRDCreate：输入内容 → 刷新页面 → 草稿恢复提示出现
- [ ] PRDCreate：选中文本 → AI 发送 → 点击插入 → 替换选区
- [ ] PRDCreate：光标在段落内 → AI 发送 → 点击插入 → 替换段落
- [ ] PRDCreate：审查弹窗打开时，Header 步骤面包屑不可点击
- [ ] UICreate：输入设计需求 → iframe 显示 HTML 预览
- [ ] UICreate：继续对话 → iframe 更新
- [ ] UICreate：点击下一步 → htmlContent 写入版本数据
- [ ] UICreate：从列表页编辑进入 → 加载已有 htmlContent
- [ ] UICreate：刷新页面 → 草稿恢复

---

## 技术栈参考

- React 19 + TypeScript + Vite 7 + Tailwind CSS
- 状态管理：AppContext（React Context）
- 路由：React Router DOM 6
- 图标：lucide-react
- 无后端，全 localStorage 持久化
- AI 调用保持 mock（setTimeout 模拟）
