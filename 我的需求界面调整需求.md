# 我的需求（PRDCreate）界面重构 PRD

## 1. 背景与目标

### 1.1 核心问题
当前「我的需求」页面采用三步走流程（新建需求 → 需求审查 → 需求导出），存在以下问题：
- AI 生成 PRD 后，用户无法局部调整生成内容，只能整体替换 textarea
- 生成、编辑、导出割裂在三个独立步骤中，操作不连贯
- AI 对话面板（左侧 1/5）只回消息不改正文，无法真正辅助编辑

### 1.2 目标
将三步走合并为单一编辑界面：75% 面积的可编辑文本区 + 底部 AI 输入栏，支持生成后手动或 AI 辅助的局部调整。

---

## 2. 布局设计

```
┌─ StepIndicator（保留：编辑 → 审查 → 导出）─────────────┐
├─ 顶部信息栏（56px）：需求名称 + 归属项目 ──────────────┤
│                                                          │
│  编辑器区域（占满剩余空间，约 75% 视口高度）             │
│  工具栏：B I U H1 H2 • 1. [] 🔗（Markdown 快捷按钮）   │
│  ┌──────────────────────────────────────────────────┐    │
│  │ Markdown 编辑区（可滚动）                        │    │
│  │ 支持手动编辑 + AI 写回                           │    │
│  └──────────────────────────────────────────────────┘    │
│                                                          │
├─ 底部吸附操作栏（~160px）────────────────────────────────┤
│  [AI 回复区 - 可折叠，带「插入/替换」按钮]              │
│  AI 输入框（自适应 60-120px）                            │
│  [📎 上传] [🎯 P1▼] [🤖 GPT-4▼]           [↑ 发送]    │
│  [💾 保存草稿] [✨ 生成PRD]                 [下一步 >]   │
└──────────────────────────────────────────────────────────┘
```

---

## 3. 关键设计决策

### 3.1 编辑器方案：Markdown textarea + 工具栏（非 TipTap）

**决策理由**：
- MVP 优先速度，TipTap 引入会增加依赖、样式调优成本
- 当前导出链（MD 导出、Word 导出）完全基于 Markdown 字符串处理
- 用 Markdown textarea + 工具栏按钮可达成 80% 富文本体验，无依赖冲突

**实现方式**：
- 保留 textarea，增加顶部工具栏（加粗、斜体、标题、列表等按钮）
- 工具栏按钮通过 `selectionStart/selectionEnd` 操作 textarea 内容
- 单一真源：**Markdown 字符串**（`requirement` state）
- 导出逻辑无需改动，直接复用现有 `handleExportMD` / `handleExportWord`

### 3.2 AI 写回策略（三种模式）

解决「AI 对话只回消息不改正文」的核心问题：

| 模式 | 触发条件 | 行为 |
|------|----------|------|
| **选区改写** | 用户选中编辑器中的文本后发送 AI 消息 | AI 返回替换内容，替换选中区域 |
| **光标段落改写** | 用户光标在某段落内（无选区）发送 AI 消息 | AI 返回该段落的优化版本，替换当前段落 |
| **追加到末尾** | 用户未聚焦编辑器时发送 AI 消息 | AI 返回内容追加到文档末尾 |

**AI 回复区交互**：
- AI 回复显示在输入框上方（可折叠）
- 每条回复带两个按钮：「插入到编辑器」（按当前模式写回）、「复制」
- 用户可在插入前预览 AI 回复内容，确认后再写回

**代码影响**：
- 现有 `handleSendChatMessage`（PRDCreate.tsx:316）需重构：不再只追加聊天消息，还要根据写回模式更新 `requirement`
- 现有 `setRequirement(generatedPRD)`（PRDCreate.tsx:243）保持不变，首次生成仍是全量替换

### 3.3 本地草稿存储

**现状问题**：AppContext 只持久化已保存的列表数据（`lexin_prd_list`），不覆盖未提交的编辑草稿。

**方案**：
- 新增 localStorage key：`lexin_draft_prd_{entityId}` / `lexin_draft_prd_new`
- 存储内容：`{ requirementName, requirement, selectedProjectId, priority, selectedModel, updatedAt }`
- 节流保存：编辑器内容变化后 1 秒节流写入 localStorage
- 页面加载时：检查是否有草稿，有则提示「检测到未保存的草稿，是否恢复？」
- 正式保存后：清除对应草稿 key

**代码影响**：
- 在 AppContext.tsx 中新增 `STORAGE_KEYS.PRD_DRAFT_PREFIX = 'lexin_draft_prd_'`
- PRDCreate.tsx 中新增 `useEffect` + `setTimeout` 节流逻辑

### 3.4 保存/版本时机重定义

**现状问题**：当前在「下一步」按钮时才落库（PRDCreate.tsx:835/838），改成弹窗后可能重复保存或漏保存。

**新方案 - 状态机**：
```
[编辑中] --点击「保存草稿」--> [草稿已保存到 localStorage]
[编辑中] --点击「下一步」--> [触发审查弹窗]
[审查弹窗] --点击「通过并继续」--> [落库到 AppContext + 触发导出弹窗]
[审查弹窗] --点击「返回修改」--> [回到编辑中]
[导出弹窗] --点击「完成」--> [清除草稿 + 跳转列表页]
```

关键规则：
- 只在「通过并继续」时执行一次 `addPRD` / `createPRDVersion`
- 弹窗打开时禁用 StepIndicator 的点击回退（避免状态冲突）
- 编辑模式（从列表页进入）：由「是否有既有内容」驱动，不依赖 step number

### 3.5 StepIndicator 与弹窗的协调

- 审查弹窗或导出弹窗打开时，StepIndicator 禁用点击
- Step 状态由实际流程驱动：编辑中=Step1，审查弹窗打开=Step2，导出弹窗打开=Step3
- 关闭弹窗自动回退 Step 状态

---

## 4. Step 2 审查 → Modal

将现有全屏审查页面（PRDCreate.tsx:690-861）提取为 `PRDReviewDialog` 弹窗组件：
- 保留评分圆环、审查项列表、通过/优化/修复统计
- 弹窗底部：「返回修改」关闭弹窗 + 「通过并继续」落库并打开导出弹窗
- 有「必须修复」项时禁用「通过并继续」

## 5. Step 3 导出 → Modal

将现有导出页面（PRDCreate.tsx:864-957）提取为 `PRDExportDialog` 弹窗组件：
- 保留所有导出选项：MD / Word / TAPD / 导入到UI设计
- 弹窗底部：「返回编辑」关闭弹窗 + 「完成」跳转列表页

---

## 6. 涉及文件清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `src/pages/PRDCreate.tsx` | 重构 | 主页面布局重构 |
| `src/components/AIInputBar.tsx` | 新增 | 底部 AI 输入栏（与设计页复用） |
| `src/components/MarkdownToolbar.tsx` | 新增 | Markdown 编辑器工具栏 |
| `src/components/PRDReviewDialog.tsx` | 新增 | 审查弹窗（提取现有审查逻辑） |
| `src/components/PRDExportDialog.tsx` | 新增 | 导出弹窗（提取现有导出逻辑） |
| `src/store/AppContext.tsx` | 修改 | 新增草稿存储 key 和相关方法 |
| `src/types/index.ts` | 不变 | PRD 类型无需改动 |

---

## 7. 不做的事（明确排除）

- 不引入 TipTap 或其他富文本编辑器依赖（MVP 阶段）
- 不改动 PRDItem / PRDVersion 类型定义
- 不改动现有导出逻辑（MD/Word 处理函数）
- 不实现真实 AI API 调用（保持 mock）
